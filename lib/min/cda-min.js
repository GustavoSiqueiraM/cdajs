"use strict";(function(window){function _Xhr(){if(window.XMLHttpRequest){return new window.XMLHttpRequest}else if(window.ActiveXObject){return new window.ActiveXObject("MSXML2.XMLHTTP.3.0")}else if(typeof require==="function"){var xhr;(xhr=function(){this.readyState=0;this.status=-1;this.statusText="Not sent";this.responseText=null}).prototype={changeStatus:function(statusCode,readyState){this.status=statusCode;this.statusText=statusCode;this.readyState=readyState;if(_isFun(this.onreadystatechange)){this.onreadystatechange.call(this,this)}},open:function(method,url,async,username,password){if(async!==true){throw"Synchronous mode not supported in this environment."}var options=require("url").parse(url);if(options.host.length>options.hostname.length){options.host=options.hostname;delete options.hostname}if(!options.path&&options.pathname){options.path=options.pathname+(options.search||"")}options.method=CDA.DEFAULT_OPTIONS.METHOD;options.headers={};if(username)options.headers.Authorization="Basic "+new Buffer(username+":"+(password||"")).toString("base64");this.options=options;this.changeStatus(-1,1)},send:function(data){var me=this,options=me.options,client;if(data){options.headers["Content-Length"]=Buffer.byteLength(data)}switch(options.protocol){case"http:":client=require("http");if(!options.port)options.port="80";break;case"https:":client=require("https");if(!options.port)options.port="443";break;default:throw"Unsupported protocol "+options.protocol}me.responseText="";var request=client.request(options,function(response){response.setEncoding("utf8");me.changeStatus(-1,2);response.on("data",function(chunk){me.responseText+=chunk;me.changeStatus(response.statusCode,3)});response.on("error",function(error){me.changeStatus(response.statusCode,4)});response.on("end",function(){me.changeStatus(response.statusCode,4)})});request.on("error",function(e){me.responseText=e;me.changeStatus(500,4)});if(data)request.write(data);request.end()},setRequestHeader:function(name,value){this.options.headers[name]=value}};return new xhr}else{CDA.Exception.newError("ERROR_INSTANTIATING_XMLHTTPREQUEST","ajax",null)._throw()}}function _convertParams(params){var form="?";var isFirst=true;for(var key in params){isFirst?isFirst=false:form+="&";var value=typeof params[key]=="function"?params[key]():params[key];form+=key+"="+value}return form}function _isUnd(arg){return typeof arg==="undefined"}function _isFun(arg){return typeof arg==="function"}function _invokeEndpoint(callback,options,endpoint,self){var xhr=_Xhr();options.method=options.method||CDA.DEFAULT_OPTIONS.METHOD;if((options.username||self.options.username)!==undefined&&(options.password||self.options.password)!==undefined){options.params["userid"]=options.username||self.options.username;options.params["password"]=options.password||self.options.password}if(Object.getOwnPropertyNames(options.params).length>0){options.form=_convertParams(options.params)}var finalUrl=(options.url||self.options.url)+endpoint+(options.method.toUpperCase()==="GET"?options.form||"":"");xhr.open(options.method,finalUrl,options.async||CDA.DEFAULT_OPTIONS.ASYNC,options.username,options.password);xhr.timeout=options.timeout||CDA.DEFAULT_OPTIONS.REQUEST_TIMEOUT;xhr.setRequestHeader("Accept",options["Accept"]||CDA.DEFAULT_OPTIONS.ACCEPT);xhr.setRequestHeader("Content-Type",options["Content-Type"]||CDA.DEFAULT_OPTIONS.CONTENT_TYPE);if(options.method.toUpperCase()==="GET"){xhr.send()}else{xhr.send(options.form||"")}xhr.onreadystatechange=function(){switch(xhr.readyState){case 0:if(_isFun(options.aborted)){options.aborted(xhr)}break;case 4:if(xhr.status===200){var response="";try{response=JSON.parse(xhr.responseText)}catch(e){response=xhr.responseText;console.log("Can not convert to JSON after invoke "+endpoint+" endpoint.")}callback(xhr.responseText==""?"":response)}else{var err=CDA.Exception.newError("HTTP_ERROR","xhr",{request:options,status:self.status,statusText:self.statusText});console.log("Error: "+err);if(!_isUnd(options.error)&&_isFun(options.error)){options.error(err)}}break}}}if(!window.JSON){window.JSON={parse:function(sJSON){return eval("("+sJSON+")")},stringify:function(vContent){if(vContent instanceof Object){var sOutput="";if(vContent.constructor===Array){for(var nId=0;nId<vContent.length;sOutput+=this.stringify(vContent[nId])+",",nId++);return"["+sOutput.substr(0,sOutput.length-1)+"]"}if(vContent.toString!==Object.prototype.toString){return'"'+vContent.toString().replace(/"/g,"\\$&")+'"'}for(var sProp in vContent){sOutput+='"'+sProp.replace(/"/g,"\\$&")+'":'+this.stringify(vContent[sProp])+","}return"{"+sOutput.substr(0,sOutput.length-1)+"}"}return typeof vContent==="string"?'"'+vContent.replace(/"/g,"\\$&")+'"':String(vContent)}}}function CDA(options){this.options=options||CDA.Exception.newError("ERROR_CDA_OPTIONS","CDA.constructor",null)._throw();this.options.url=options.url||CDA.Exception.newError("ERROR_CDA_URL","CDA.constructor",null)._throw();if(typeof exports==="undefined"){this.options.username=options.username;this.options.password=options.password}else{this.options.username=options.username||CDA.Exception.newError("ERROR_CDA_USERNAME","CDA.constructor",null)._throw();this.options.password=options.password||CDA.Exception.newError("ERROR_CDA_PASSWORD","CDA.constructor",null)._throw()}this.options.params=options.params||{}}CDA.DEFAULT_OPTIONS={REQUEST_TIMEOUT:6e4,ASYNC:true,ACCEPT:"text/xml, application/json",CONTENT_TYPE:"application/json",METHOD:"GET"};CDA.prototype.doQuery=function(callback,options){var endpoint="doQuery";if(_isUnd(options)){options=this.options}if(_isUnd(options.params)||_isUnd(options.params.dataAccessId)){CDA.Exception.newError("ERROR_MISSING_DATA_ACCESS_ID",endpoint,null)._throw()}_invokeEndpoint(callback,options,endpoint,this)};CDA.prototype.listQueries=function(callback,options){var endpoint="listQueries";if(_isUnd(options)){options=this.options}if(_isUnd(options.params)){CDA.Exception.newError("ERROR_MISSING_PARAMS",endpoint,null)._throw()}if(_isUnd(options.params.path)){CDA.Exception.newError("ERROR_MISSING_PARAMS_PATH",endpoint,null)._throw()}_invokeEndpoint(callback,options,endpoint,this)};CDA.prototype.getCdaList=function(callback,options){var endpoint="getCdaList";if(_isUnd(options)){options=this.options}_invokeEndpoint(callback,options,endpoint,this)};CDA.prototype.listDataAccessTypes=function(callback,options){var endpoint="listDataAccessTypes";if(_isUnd(options)){options=this.options}_invokeEndpoint(callback,options,endpoint,this)};CDA.prototype.listParameters=function(callback,options){var endpoint="listParameters";if(_isUnd(options)){options=this.options}if(_isUnd(options.params)){CDA.Exception.newError("ERROR_MISSING_PARAMS",endpoint,null)._throw()}if(_isUnd(options.params.path)){CDA.Exception.newError("ERROR_MISSING_PARAMS_PATH",endpoint,null)._throw()}if(_isUnd(options.params.dataAccessId)){CDA.Exception.newError("ERROR_MISSING_PARAMS_DATA_ACCESS_ID",endpoint,null)._throw()}_invokeEndpoint(callback,options,endpoint,this)};CDA.prototype.clearCache=function(callback,options){var endpoint="clearCache";if(_isUnd(options)){options=this.options}_invokeEndpoint(callback,options,endpoint,this)};CDA.prototype.getCdaFile=function(callback,options){var endpoint="getCdaFile";if(_isUnd(options)){options=this.options}_invokeEndpoint(callback,options,endpoint,this)};CDA.Exception=function(type,code,message,helpfile,source,data,args){this.type=type;this.code=code;this.message=message;this.source=source;this.helpfile=helpfile;this.data=data;this.args=args;return this};CDA.Exception.newError=function(codeName,source,data){return new this.newDetailError(CDA.Exception[codeName+"_CODE"],CDA.Exception[codeName+"_MSG"],CDA.Exception[codeName+"_HELP"],source,data)};CDA.Exception.newDetailError=function(code,message,help,source,data){return new CDA.Exception(CDA.Exception.TYPE_ERROR,code,message,help,source,data)};var CDAWikiExceptionCodes="https://github.com/latinojoel/cdajs/wiki/Exception-Codes";CDA.Exception.TYPE_ERROR="error";CDA.Exception.TYPE_WARNING="warning";CDA.Exception.ERROR_CDA_URL_CODE=-1;CDA.Exception.ERROR_CDA_URL_MSG="Missing CDA URL";CDA.Exception.ERROR_CDA_URL_HELP="Please provide CDA url on the CDA object constructor (Please consult this page "+CDAWikiExceptionCodes+")";CDA.Exception.ERROR_CDA_OPTIONS_CODE=-2;CDA.Exception.ERROR_CDA_OPTIONS_MSG="Missing CDA Options";CDA.Exception.ERROR_CDA_OPTIONS_HELP="Please provide CDA options on the CDA object constructor (Please consult this page "+CDAWikiExceptionCodes+")";CDA.Exception.HTTP_ERROR_CODE=-3;CDA.Exception.HTTP_ERROR_MSG="HTTP ERROR";CDA.Exception.HTTP_ERROR_HELP="Generic HTTP error (Please consult this page "+CDAWikiExceptionCodes+")";CDA.Exception.ERROR_CDA_USERNAME_CODE=-4;CDA.Exception.ERROR_CDA_USERNAME_MSG="Missing CDA Username";CDA.Exception.ERROR_CDA_USERNAME_HELP="Please provide CDA username on the CDA object constructor (Please consult this page "+CDAWikiExceptionCodes+")";CDA.Exception.ERROR_CDA_PASSWORD_CODE=-5;CDA.Exception.ERROR_CDA_PASSWORD_MSG="Missing CDA Password";CDA.Exception.ERROR_CDA_PASSWORD_HELP="Please provide CDA password on the CDA object constructor (Please consult this page "+CDAWikiExceptionCodes+")";CDA.Exception.ERROR_MISSING_DATA_ACCESS_ID_CODE=-6;CDA.Exception.ERROR_MISSING_DATA_ACCESS_ID_MSG="Missing CDA data access id";CDA.Exception.ERROR_MISSING_DATA_ACCESS_ID_HELP="Please provide CDA data access id (Please consult this page "+CDAWikiExceptionCodes+")";CDA.Exception.ERROR_MISSING_PARAMS_CODE=-7;CDA.Exception.ERROR_MISSING_PARAMS_MSG="Missing object params";CDA.Exception.ERROR_MISSING_PARAMS_HELP="Please provide params (Please consult this page "+CDAWikiExceptionCodes+")";CDA.Exception.ERROR_MISSING_PARAMS_PATH_CODE=-9;CDA.Exception.ERROR_MISSING_PARAMS_PATH_MSG="Missing path property on object params";CDA.Exception.ERROR_MISSING_PARAMS_PATH_HELP="Please provide path property on params (Please consult this page "+CDAWikiExceptionCodes+")";CDA.Exception.prototype={type:null,code:null,message:null,source:null,helpfile:null,data:null,_throw:function(){throw this},args:null,toString:function(){return this.type+" "+this.code+": "+this.message+" (source: "+this.source+")"},getStackTrace:function(){var stack="";if(this.args){var func=this.args.callee;while(func){funcstring=String(func);func=func.caller}}return stack}};if(typeof define==="function"&&define.amd){define(function(){return CDA})}else window.CDA=CDA;return CDA})(typeof exports==="undefined"?window:exports);